generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum UserRole {
  DRIVER
  OFFICER
  ADMIN
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  OVERDUE
}

enum TicketStatus {
  PENDING
  PAID
  APPEALED
  DISMISSED
}

enum VehicleType {
  CAR
  MOTORCYCLE
  TRUCK
}

enum EntryMethod {
  MANUAL
  OCR
}

// Models

model Profile {
  id          String   @id @default(uuid()) @db.Uuid // References auth.users.id
  fullName    String?  @map("full_name")
  role        UserRole @default(DRIVER)
  balance     Decimal  @default(0.00) @db.Decimal(10, 2)
  phoneNumber String?  @map("phone_number")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  vehicles          Vehicle[]
  notifications     Notification[]
  issuedTickets     Ticket[]       @relation("OfficerTickets")
  receivedTickets   Ticket[]       @relation("OffenderTickets")

  @@map("profiles")
}

model Vehicle {
  id          String      @id @default(uuid()) @db.Uuid
  plateNumber String      @unique @map("plate_number")
  ownerId     String      @map("owner_id") @db.Uuid
  type        VehicleType
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  owner    Profile          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  sessions ParkingSession[]
  tickets  Ticket[]

  @@map("vehicles")
}

model ParkingZone {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  ratePerHour Decimal  @map("rate_per_hour") @db.Decimal(10, 2)
  currency    String   @default("RWF")
  location    String? // Could be lat/long string or description
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  sessions ParkingSession[]
  tickets  Ticket[]

  @@map("parking_zones")
}

model ParkingSession {
  id          String        @id @default(uuid()) @db.Uuid
  vehicleId   String        @map("vehicle_id") @db.Uuid
  zoneId      String        @map("zone_id") @db.Uuid
  startTime   DateTime      @default(now()) @map("start_time")
  endTime     DateTime?     @map("end_time")
  totalCost   Decimal?      @map("total_cost") @db.Decimal(10, 2)
  status      SessionStatus @default(ACTIVE)
  
  // OCR / Phone as Camera Fields
  entryImageUrl String?     @map("entry_image_url")
  entryMethod   EntryMethod @default(MANUAL) @map("entry_method")
  deviceId      String?     @map("device_id")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  vehicle Vehicle     @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  zone    ParkingZone @relation(fields: [zoneId], references: [id])

  @@map("parking_sessions")
}

model Ticket {
  id               String       @id @default(uuid()) @db.Uuid
  offenderId       String?      @map("offender_id") @db.Uuid
  vehicleId        String?      @map("vehicle_id") @db.Uuid
  officerId        String       @map("officer_id") @db.Uuid
  zoneId           String?      @map("zone_id") @db.Uuid
  violationType    String       @map("violation_type")
  fineAmount       Decimal      @map("fine_amount") @db.Decimal(10, 2)
  evidenceImageUrl String?      @map("evidence_image_url")
  status           TicketStatus @default(PENDING)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  offender Profile?    @relation("OffenderTickets", fields: [offenderId], references: [id])
  officer  Profile     @relation("OfficerTickets", fields: [officerId], references: [id])
  vehicle  Vehicle?    @relation(fields: [vehicleId], references: [id])
  zone     ParkingZone? @relation(fields: [zoneId], references: [id])

  @@map("tickets")
}

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String
  message   String
  read      Boolean  @default(false)
  type      String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}
